---
AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: 'Deploy A11ygator Bot application.'

Parameters:
  ConsumerKey:
    Type: 'String'
    Description: 'Consumer key of Twitter application.'
  ConsumerSecret:
    Type: 'String'
    Description: 'Consumer secret of Twitter application.'
    NoEcho: yes
  OAuthToken:
    Type: 'String'
    Description: 'OAuth Token of Twitter user.'
  OAuthTokenSecret:
    Type: 'String'
    Description: 'Secret of OAuth Token of Twitter user.'
    NoEcho: yes
  ApiLoggingLevel:
    Type: 'String'
    AllowedValues:
      - 'OFF'
      - 'ERROR'
      - 'INFO'
    Description: 'Logging level of API Gateway stage.'
    Default: 'ERROR'

Outputs:
  TwitterWebhookUrl:
    Description: 'URL of Twitter Webhook.'
    Value: !Sub 'https://${Api}.execute-api.${AWS::Region}.amazonaws.com/prod/webhook/twitter'

Resources:
  TweetsQueue:
    Type: 'AWS::SQS::Queue'

  ###########################################################
  ### Function to handle Twitter Challenge Response Check ###
  ###########################################################
  TwitterCrcRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'lambda.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
  TwitterCrcFunction:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code: '../lambda/crc'
      Description: !Sub 'Handle Twitter Challenge Response Check for ${AWS::StackName}.'
      Environment:
        Variables:
          CONSUMER_SECRET: !Ref 'ConsumerSecret'
      Handler: 'index.handler'
      Role: !GetAtt 'TwitterCrcRole.Arn'
      Runtime: 'nodejs8.10'
  TwitterCrcFunctionPermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      FunctionName: !GetAtt 'TwitterCrcFunction.Arn'
      Action: 'lambda:InvokeFunction'
      Principal: 'apigateway.amazonaws.com'
      SourceArn: !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*/GET/webhook/twitter'

  #################################################
  ### Function to handle Twitter webhook events ###
  #################################################
  TwitterWebhookRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'lambda.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: 'SQS'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: 'EnqueueTweets'
                Effect: 'Allow'
                Action: 'sqs:SendMessage'
                Resource: !GetAtt 'TweetsQueue.Arn'
  TwitterWebhookFunction:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code: '../lambda/webhook'
      Description: !Sub 'Handle Twitter webhook events for ${AWS::StackName}.'
      Environment:
        Variables:
          SQS_QUEUE: !Ref 'TweetsQueue'
          CONSUMER_SECRET: !Ref 'ConsumerSecret'
      Handler: 'index.handler'
      Role: !GetAtt 'TwitterWebhookRole.Arn'
      Runtime: 'nodejs8.10'
  TwitterWebhookFunctionPermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      FunctionName: !GetAtt 'TwitterWebhookFunction.Arn'
      Action: 'lambda:InvokeFunction'
      Principal: 'apigateway.amazonaws.com'
      SourceArn: !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*/POST/webhook/twitter'

  ##########################################
  ### Function to process queue messages ###
  ##########################################
  QueueTriggerRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'lambda.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: 'SQS'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: 'ConsumeTweets'
                Effect: 'Allow'
                Action:
                  - 'sqs:ReceiveMessage'
                  - 'sqs:DeleteMessage'
                  - 'sqs:GetQueueAttributes'
                Resource: !GetAtt 'TweetsQueue.Arn'
  QueueTriggerFunction:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code: '../lambda/consumer'
      Description: !Sub 'Consume tweet queue messages for ${AWS::StackName}.'
      Environment:
        Variables:
          CONSUMER_KEY: !Ref 'ConsumerKey'
          CONSUMER_SECRET: !Ref 'ConsumerSecret'
          OAUTH_TOKEN: !Ref 'OAuthToken'
          OAUTH_TOKEN_SECRET: !Ref 'OAuthTokenSecret'
      Handler: 'index.handler'
      Role: !GetAtt 'QueueTriggerRole.Arn'
      Runtime: 'nodejs8.10'
      Timeout: 30
  QueueTriggerFunctionEventSourceMapping:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      Enabled: yes
      EventSourceArn: !GetAtt 'TweetsQueue.Arn'
      FunctionName: !GetAtt 'QueueTriggerFunction.Arn'

  ###################
  ### API Gateway ###
  ###################
  Api:
    Type: 'AWS::Serverless::Api'
    Properties:
      Name: !Ref 'AWS::StackName'
      StageName: 'prod'
      EndpointConfiguration: 'REGIONAL'
      MethodSettings:
        - HttpMethod: '*'
          ResourcePath: '/*'
          LoggingLevel: !Ref 'ApiLoggingLevel'
      DefinitionBody:
        openapi: '3.0.0'
        schemes:
          - 'https'
        x-amazon-apigateway-request-validators:
          all:
            validateRequestBody: yes
            validateRequestParameters: yes
        paths:
          /webhook/twitter:
            get:
              description: !Sub 'Twitter Challenge Response Check endpoint for ${AWS::StackName}.'
              x-amazon-apigateway-request-validator: 'all'
              parameters:
                - in: 'query'
                  name: 'crc_token'
                  schema:
                    type: 'string'
                  description: 'Challenge Response Check token.'
                  required: yes
              responses:
                '200':
                  description: 'Challenge Response.'
                  content:
                    application/json:
                      schema:
                        $ref: '#/components/schemas/TwitterCrcResponse'
              security:
                - api_key: []
              x-amazon-apigateway-integration:
                type: 'aws_proxy'
                httpMethod: 'POST'
                uri: !Sub 'arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TwitterCrcFunction.Arn}/invocations'
            post:
              description: !Sub 'Webhook endpoint for ${AWS::StackName}.'
              x-amazon-apigateway-request-validator: 'all'
              parameters:
                - in: 'header'
                  name: 'X-Twitter-Webhooks-Signature'
                  schema:
                    type: 'string'
                  description: 'Twitter Webhook Signature.'
                  required: true
              requestBody:
                content:
                  application/json:
                    schema:
                      $ref: '#/components/schemas/TwitterWebhookRequest'
              responses:
                '204':
                  description: 'Acknowledged.'
              security:
                - api_key: []
              x-amazon-apigateway-integration:
                type: 'aws_proxy'
                httpMethod: 'POST'
                uri: !Sub 'arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TwitterWebhookFunction.Arn}/invocations'
        components:
          schemas:
            TwitterCrcResponse:
              type: 'object'
              properties:
                response_token:
                  type: 'string'
              required:
                - 'response_token'
              additionalProperties: no
            TwitterWebhookRequest:
              type: 'object'
